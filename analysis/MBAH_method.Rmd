---
title: '20240221'
author: "Hiromichi Hagihara"
date: "2024-02-21"
output: html_document
---

```{r}
library(tidyverse)
library(effsize)
library(here)
library(lme4)
library(lmerTest)
library(car)
library(emmeans)
library(gtools)
library(ggeffects)
```

```{r}
d <- read.csv(here("Data", "all_concat_2025May14.csv"), header=TRUE) %>% 
  filter(!filename %in% c("35.mp4", "37.mp4", "38.mp4"))

d$folder %>% unique()
d$filename %>% unique() %>% length()
d$onset %>% unique()
d$trial %>% unique()

d.raw <- d %>% filter(str_detect(onset, "^trial") & !str_detect(folder, "brighterAI"))
d.anonym <- d %>% filter(str_detect(onset, "^trial") & str_detect(folder, "brighterAI"))
d.raw$folder %>% unique()
d.anonym$folder %>% unique()

d.raw$filename %>% unique() %>% mixedsort() #%>% length()
d.raw$filename %>% unique() %>% mixedsort() %>% length()
d.anonym$filename %>% unique() %>% mixedsort() #%>% length()
d.anonym$filename %>% unique() %>% mixedsort() %>% length()

d.par <- d.raw %>% select(folder, filename) %>% unique() %>% 
  left_join(read.csv(here("Data", "participant_info.csv"), header=TRUE), by=c("folder", "filename"))

d.par %>% summarize(M=mean(child__age_in_days), SD=sd(child__age_in_days), Min=min(child__age_in_days), Max=max(child__age_in_days))
d.par$child__gender %>% table()
```


Noise factors
- distance = Distance to the camera (pose_Tz): mm
- offset_x = Left-right offset (pose_Tx): mm, 0=center, the more right-bottom from the camera view, the bigger the value
- angle = Facial rolling (pose_Rz = roll): radian, the bigger value indicate rolling toward right from the camera view
- lighting = difference in brightness in left-right face regions, L-value 
- movement (pose_Tx, pose_Ty: lag -> calculate distance
- *occulusion: confidence [0,1], not used in the analyses

```{r}
# Movement
tmp.raw <- d.raw %>% group_by(filename, trial, onset) %>% 
  mutate(diff_x = offset_x - lag(offset_x),
         diff_y = offset_y - lag(offset_y),
         movement = sqrt(diff_x^2 + diff_y^2)) %>% 
  select(filename, trial, onset, frame, movement)

tmp.anonym <- d.anonym %>% group_by(filename, trial, onset) %>% 
  mutate(diff_x = offset_x - lag(offset_x),
         diff_y = offset_y - lag(offset_y),
         movement = sqrt(diff_x^2 + diff_y^2)) %>% 
  select(filename, trial, onset, frame, movement)

d.raw <- d.raw %>% left_join(tmp.raw, by=c("filename", "trial", "onset", "frame"))
d.anonym <- d.anonym %>% left_join(tmp.anonym, by=c("filename", "trial", "onset", "frame"))

d.raw %>% select(distance, offset_x, offset_y, angle, l_mu, r_mu, movement, occlusion) %>% summary()

# Calculate noise factors (include directions, not absolute values; not used in the analysis)
d.raw <- d.raw %>% mutate(offset_left = case_when(offset_x > 0 ~ offset_x, TRUE ~ 0),
                          offset_right = abs(case_when(offset_x <= 0 ~ offset_x, TRUE ~ 0)),
                          angle_left = case_when(angle > 0 ~ angle, TRUE ~ 0),
                          angle_right = abs(case_when(angle <= 0 ~ angle, TRUE ~ 0)),
                          l_diff = l_mu - r_mu,
                          lighting_left = case_when(l_diff > 0 ~ l_diff, TRUE ~ 0),
                          lighting_right = abs(case_when(l_diff <= 0 ~ l_diff, TRUE ~ 0)))

d.raw %>% select(distance, offset_left, offset_right, angle_left, angle_right, lighting_left, lighting_right, movement, occlusion) %>% summary()

d.raw.noise.sum <- d.raw %>% group_by(filename, trial, onset, objectMovement, objectNumber, complexity, shape, leftSide, rightSide, sound) %>% 
  summarize(distance = mean(distance, na.rm=TRUE),
            offset_left = mean(offset_left, na.rm=TRUE),
            offset_right = mean(offset_right, na.rm=TRUE),
            angle_left = mean(angle_left, na.rm=TRUE),
            angle_right = mean(angle_right, na.rm=TRUE),
            lighting_left = mean(lighting_left, na.rm=TRUE),
            lighting_right = mean(lighting_right, na.rm=TRUE),
            movement = sum(movement, na.rm=TRUE),
            occlusion = mean(occlusion, na.rm=TRUE)) %>% ungroup() %>% 
  mutate(across(distance:occlusion, ~ as.numeric(scale(.)), .names = "{.col}_z"))

tmp <- d.raw.noise.sum %>% summarize(across(ends_with("_z"), list(mean = ~mean(.x, na.rm=TRUE), sd = ~sd(.x, na.rm=TRUE)), .names="{.col}_{.fn}"))
tmp

d.raw.noise.sum$offset_left %>% mean(na.rm=TRUE) %>% round()
d.raw.noise.sum$offset_left %>% sd(na.rm=TRUE) %>% round()
d.raw.noise.sum$offset_right %>% mean(na.rm=TRUE) %>% round()
d.raw.noise.sum$offset_right %>% sd(na.rm=TRUE) %>% round()


# Calculate noise factors (absolute values)
d.raw <- d.raw %>% mutate(offset_abs = abs(offset_x),
                          angle_abs = abs(angle),
                          lighting_abs = abs(l_mu - r_mu))

d.raw %>% select(distance, offset_abs, angle_abs, lighting_abs, movement, occlusion) %>% summary()

d.raw.noise.sum2 <- d.raw %>% group_by(filename, trial, onset, objectMovement, objectNumber, complexity, shape, leftSide, rightSide, sound) %>% 
  summarize(distance = mean(distance, na.rm=TRUE),
            offset_abs = mean(offset_abs, na.rm=TRUE),
            angle_abs = mean(angle_abs, na.rm=TRUE),
            lighting_abs = mean(lighting_abs, na.rm=TRUE),
            movement = sum(movement, na.rm=TRUE),
            occlusion = mean(occlusion, na.rm=TRUE)) %>% ungroup() %>% 
  mutate(across(distance:occlusion, ~ as.numeric(scale(.)), .names = "{.col}_z"))

tmp2 <- d.raw.noise.sum2 %>% summarize(across(ends_with("_z"), list(mean = ~mean(.x, na.rm=TRUE), sd = ~sd(.x, na.rm=TRUE)), .names="{.col}_{.fn}"))
tmp2

d.raw.noise.sum2$distance %>% mean(na.rm=TRUE) %>% round()
d.raw.noise.sum2$distance %>% sd(na.rm=TRUE) %>% round()


# Calculate noise factors (include directions by discretizing the value)
d.raw.noise.sum3 <- d.raw %>% group_by(filename, trial, onset, objectMovement, objectNumber, complexity, shape, leftSide, rightSide, sound) %>% 
  summarize(offset2 = mean(-offset_x, na.rm=TRUE),  # More rightward (from the infant view) -> Positive
            angle2 = mean(-angle, na.rm=TRUE),      # More rightward (from the infant view) -> Positive
            lighting2 = mean((r_mu - l_mu), na.rm=TRUE)) %>% # the right-side is brighter (from the infant view) -> Positive 
  ungroup() %>% 
  mutate(across(offset2:lighting2, ~ as.numeric(scale(.)), .names = "{.col}_z")) 

tmp3 <- d.raw.noise.sum3 %>% summarize(across(ends_with("_z"), list(mean = ~mean(.x, na.rm=TRUE), sd = ~sd(.x, na.rm=TRUE)), .names="{.col}_{.fn}"))
tmp3

d.raw.noise.sum3 %>% pivot_longer(offset2:lighting2, names_to="Cat", values_to="Val") %>% 
  group_by(Cat) %>% 
  summarize(N=n(), Mean=mean(Val, na.rm=TRUE), SD=mean(Val, na.rm=TRUE), Min=min(Val, na.rm=TRUE), Max=max(Val, na.rm=TRUE))
d.raw.noise.sum3 %>% select(offset2:lighting2) %>% summary()

d.raw.noise.sum3 <- d.raw.noise.sum3 %>% 
  mutate(offset_bin   = cut(offset2,   breaks=c(-Inf, -30, 0, 30, Inf), labels=1:4, include.lowest=TRUE),
         angle_bin    = cut(angle2,    breaks=c(-Inf, -0.0872665, 0, 0.0872665, Inf), labels=1:4, include.lowest=TRUE),
         lighting_bin = cut(lighting2, breaks=c(-Inf, -25, 0, 25, Inf), labels=1:4, include.lowest=TRUE))
  # mutate(offset_bin   = cut(offset2_z,   breaks=c(-Inf, -0.5, 0, 0.5, Inf), labels=1:4, include.lowest=TRUE),
  #        angle_bin    = cut(angle2_z,    breaks=c(-Inf, -0.5, 0, 0.5, Inf), labels=1:4, include.lowest=TRUE),
  #        lighting_bin = cut(lighting2_z, breaks=c(-Inf, -0.5, 0, 0.5, Inf), labels=1:4, include.lowest=TRUE))

d.raw.noise.sum3 %>% select(offset_bin, angle_bin, lighting_bin) %>% summary()

d.raw.noise.sum3 %>% group_by(offset_bin) %>% 
  summarize(N=n(), Mean=mean(offset2, na.rm=TRUE), SD=sd(offset2, na.rm=TRUE), Min=min(offset2), Max=max(offset2))

d.raw.noise.sum3 %>% group_by(angle_bin) %>% 
  summarize(N=n(), Mean=mean(angle2, na.rm=TRUE), SD=sd(angle2, na.rm=TRUE), Min=min(angle2), Max=max(angle2))

d.raw.noise.sum3 %>% group_by(lighting_bin) %>% 
  summarize(N=n(), Mean=mean(lighting2, na.rm=TRUE), SD=sd(lighting2, na.rm=TRUE), Min=min(lighting2), Max=max(lighting2))

library(GGally)
d.raw.noise.sum %>% select(distance_z:occlusion_z) %>% ggpairs()
d.raw.noise.sum2 %>% select(distance_z:occlusion_z) %>% ggpairs()
d.raw.noise.sum3 %>% select(offset_z:lighting_z) %>% ggpairs()
```



# Fps variability between and within pariticpants (not used in this study)

Calculate/Analyze fps variability within/between participants/trials

```{r}
# Non-anonym data only
d.tmp <- d.raw %>% group_by(filename, trial, onset, objectMovement, objectNumber, complexity, shape, leftSide, rightSide, sound) %>% 
  summarize(N.frame = n(),
            Min.time = min(pts_time),
            Max.time = max(pts_time),
            Duration = Max.time - Min.time,
            Fps = N.frame / Duration) %>% ungroup()

d.tmp.ind <- d.tmp %>% group_by(filename) %>% 
  summarize(N.trial = n(), M.fps = mean(Fps), SD.fps = sd(Fps)) %>% ungroup()
            
d.tmp.ind %>% summary()

d.tmp.ind.long <- d.tmp.ind %>% pivot_longer(M.fps:SD.fps, names_to="Variable", values_to="Value")

d.tmp.sum <- d.tmp.ind.long %>% group_by(Variable) %>% 
  summarize(N=n(), M=mean(Value, na.rm=TRUE), SD=sd(Value, na.rm=TRUE), SE=SD/sqrt(N))
d.tmp.sum

d.tmp.ind.long %>% ggplot(aes(x=Variable, y=Value))+
  geom_bar(data=d.tmp.sum, aes(y=M), stat="identity", alpha=0.5)+
  geom_errorbar(data=d.tmp.sum, aes(y=M, ymax=M+SE, ymin=M-SE), width=0.3)+
  geom_jitter(alpha=0.4, width=0.05, height=0.002)+
  theme_classic()+
  labs(y="Frame rate (fps)")+
  facet_wrap(~Variable, scales="free")

# tests
# Between participants
t.test(d.tmp.ind$M.fps, mu=30)
cohen.d(d.tmp.ind$M.fps, mu=30, f=NA) #effect size 

ref.fps <- 15:30
df.tmp <- data.frame()
for (i in seq_along(ref.fps)){
  comp <- t.test(d.tmp.ind$M.fps, mu=ref.fps[i])
  es <- cohen.d(d.tmp.ind$M.fps, mu=ref.fps[i], f=NA) #effect size 
  df.tmp <- df.tmp %>% rbind(data.frame(ref.fps=ref.fps[i], t.value=comp$statistic, t.df=comp$parameter, p.value=comp$p.value,
                                        ci.lower=comp$conf.int[1], ci.upper=comp$conf.int[2], cohen.D=es$estimate))
}

df.tmp <- df.tmp %>% mutate(p.value.adj=p.adjust(p.value, method="holm", n=length(p.value)),
                            sig=p.adjust(p.value, method="holm", n=length(p.value)) < .05)
df.tmp

# Within participants
t.test(d.tmp.ind$SD.fps, mu=0)
cohen.d(d.tmp.ind$SD.fps, f=NA, mu=0) #effect size 

# Regression (Stimuli-led difference)
fit <- lmer(Fps ~ objectMovement + complexity + shape + sound + trial + (1|filename), data=d.tmp) # objectNumber 
summary(fit)

# Regression (Noise-led difference)
d.tmp <- d.tmp %>% left_join(d.raw.noise.sum, by=intersect(colnames(d.tmp), colnames(d.raw.noise.sum)))
fit <- lmer(Fps ~ distance_z + offset_left_z + offset_right_z + angle_left_z + angle_right_z + lighting_left_z + lighting_right_z + movement_z + (1|filename), data=d.tmp)
summary(fit)
vif(fit) # all < 5

d.tmp <- d.tmp %>% left_join(d.raw.noise.sum2, by=intersect(colnames(d.tmp), colnames(d.raw.noise.sum2)))
fit <- lmer(Fps ~ distance_z + offset_abs_z + angle_abs_z + lighting_abs_z + movement_z + (1|filename), data=d.tmp)
summary(fit)
vif(fit) # all < 5
```



# Human vs human gaze-coding comparisons (human-human LOOSE reliability)

Human-Human reliability: left/right/away -> agree (1) / disagree (0)
%agreement, kappa coefficient

```{r}
d.hh <- read.csv(here("Data", "all_concat_HumanHuman.csv"), header=TRUE)

d.hh$folder %>% unique()
d.hh$filename %>% unique() %>% length()
d.hh$onset %>% unique()
d.hh$trial %>% unique()

d.hh <- d.hh %>% filter(str_detect(onset, "^trial"))
d.hh$folder %>% unique()
d.hh$onset %>% unique()
d.hh$HK %>% unique()
d.hh$MT %>% unique()

d.hh %>% filter(HK=="unsure") %>% select(MT_as_ref, HK_as_ref) %>% unique() # Exclude from analysis if "unsure"
d.hh %>% filter(is.na(MT)) %>% select(MT_as_ref, HK_as_ref) %>% unique()    # Exclude from analysis if "NA"

d.hh.sum <- d.hh %>% group_by(filename, onset) %>% 
  summarize(N.frame = n(),
            Prop.MT_as_ref = sum(MT_as_ref==1, na.rm=TRUE) / N.frame,
            Prop.HK_as_ref = sum(HK_as_ref==1, na.rm=TRUE) / N.frame) %>% ungroup() %>% 
  mutate(M.prop = (Prop.MT_as_ref + Prop.HK_as_ref)/2)

mean(d.hh.sum$M.prop)
sd(d.hh.sum$M.prop)

d.hh.sum %>% ggplot(aes(x=M.prop))+
  geom_histogram(color="white")+
  theme_classic()

d.hh.sum %>% subset(M.prop < 0.5)
```



# Automated vs hand-coded gaze-coding comparisons (human-model LOOSE reliability)

iCatcher+ / OWLET / Revised AR-based model

3-category (left / right / away) -> chance = 33%
2-category (look / away) -> chance = 50%

```{r}
d.raw$human_annotation %>% unique()
d.raw$human2_annotation %>% unique()

d.tmp <- d.raw %>% group_by(filename, trial, onset, objectMovement, objectNumber, complexity, shape, leftSide, rightSide, sound) %>% 
  summarize(N.frame3 = sum(human_annotation!="unsure"),
            N.frame2 = sum(human2_annotation!="unsure"),
            icatcher.crr3 = sum(icatcher_pred_as_ref=="1", na.rm=TRUE),
            icatcher.crr2 = sum(icatcher2_pred_as_ref=="1", na.rm=TRUE),
            owlet.crr3 = sum(owlet_pred_as_ref=="1", na.rm=TRUE),
            owlet.crr2 = sum(owlet2_pred_as_ref, na.rm=TRUE),
            ar.crr3 = sum(ar_pred_as_ref=="1", na.rm=TRUE),
            ar.crr2 = sum(ar2_pred_as_ref=="1", na.rm=TRUE)) %>% ungroup() %>% 
  mutate(icatcher.prop3 = icatcher.crr3/N.frame3,
         icatcher.prop2 = icatcher.crr2/N.frame2,
         owlet.prop3 = owlet.crr3/N.frame3,
         owlet.prop2 = owlet.crr2/N.frame2,
         ar.prop3 = ar.crr3/N.frame3,
         ar.prop2 = ar.crr2/N.frame2)

d.tmp %>% mutate(N.frame.diff = N.frame3 - N.frame2) %>% select(N.frame.diff) %>% summary() # N.frame3 = N.frame2
d.tmp <- d.tmp %>% select(-N.frame2) %>% rename(N.frame=N.frame3)


# left vs right vs away
d.tmp %>% group_by(filename) %>% 
  summarize(N.trial = n(), 
            M.icatcher = mean(icatcher.prop3, na.rm=TRUE), 
            M.owlet = mean(owlet.prop3, na.rm=TRUE), 
            M.ar= mean(ar.prop3, na.rm=TRUE), 
            SD.icatcher = sd(icatcher.prop3, na.rm=TRUE),
            SD.owlet = sd(owlet.prop3, na.rm=TRUE),
            SD.ar = sd(ar.prop3, na.rm=TRUE)) %>% ungroup() %>% summary()

# look vs away
d.tmp %>% group_by(filename) %>% 
  summarize(N.trial = n(), 
            M.icatcher = mean(icatcher.prop2, na.rm=TRUE), 
            M.owlet = mean(owlet.prop2, na.rm=TRUE), 
            M.ar= mean(ar.prop2, na.rm=TRUE), 
            SD.icatcher = sd(icatcher.prop2, na.rm=TRUE),
            SD.owlet = sd(owlet.prop2, na.rm=TRUE),
            SD.ar = sd(ar.prop2, na.rm=TRUE)) %>% ungroup() %>% summary()

d.tmp.long <- d.tmp %>% pivot_longer(icatcher.crr3:ar.prop2, names_to=c("model", "variable"), values_to="value", names_sep="\\.") %>% 
  mutate(model=factor(model, levels=c("icatcher", "owlet", "ar")))

d.tmp.ind <- d.tmp.long %>% filter(str_detect(variable, "prop")) %>% 
  group_by(filename, model, variable) %>% 
  summarize(N.trial = n(), 
            M = mean(value, na.rm=TRUE), 
            SD = sd(value, na.rm=TRUE)) %>% ungroup()

d.tmp.sum <- d.tmp.ind %>% group_by(model, variable) %>% 
  summarize(N=n(), MM=mean(M, na.rm=TRUE), SD=sd(M, na.rm=TRUE), SE=SD/sqrt(N))
d.tmp.sum

facet_labels <- c("prop2"="2 categories\n(Looking or Away)", "prop3"="3 categories\n(Left, Right, or Away)")
model_labels <- c("icatcher"="iCatcher+", "owlet"="OWLET", "ar"="AR-based")

d.tmp.ind %>%
  ggplot(aes(x=model, y=M, color=model, fill=model))+
  geom_bar(data=d.tmp.sum, aes(y=MM), stat="identity", alpha=0.5)+
  geom_errorbar(data=d.tmp.sum, aes(y=MM, ymax=MM+SE, ymin=MM-SE), width=0.3)+
  geom_jitter(alpha=0.3, width=0.05, height=0.002)+
  # y=0.5 for Category:2
  geom_hline(data=data.frame(variable="prop2"), aes(yintercept=0.5), linetype="dashed")+
  # y=0.33 for Category:3
  geom_hline(data=data.frame(variable="prop3"), aes(yintercept=0.33), linetype="dashed")+
  theme_classic()+
  facet_wrap(~variable, labeller=labeller(variable=facet_labels))+
  scale_x_discrete(labels=model_labels)+ 
  labs(y="Proportion of correct prediction", x="Model")+
  guides(color="none", fill="none")+
  theme(plot.title=element_text(size=16,face="bold", color="black"),
        axis.ticks=element_line(color = "black"),
        axis.text.x=element_text(size=14, color = "black"),
        axis.text=element_text(size=14, color = "black"),
        axis.title=element_text(size=14, color="black"),
        strip.text=element_text(size=14),
        legend.title=element_text(size=14, color="black", hjust=0.2),
        legend.text=element_text(size=12, color="black"))
ggsave(file=here("Figures", "Figure_1.png"), dpi=350, width=7.7, height=6.5)
```


```{r}
# Comparison among algorithms 
d.tmp.ind <- d.tmp.long %>% filter(str_detect(variable, "crr")) %>% 
  rename(N.crr=value)

d.tmp.ind.sum <- d.tmp.ind %>% group_by(filename, model, variable) %>% 
  summarize(N.trial = n(), 
            N.frame = sum(N.frame, na.rm=TRUE),
            N.crr = sum(N.crr, na.rm=TRUE)) %>% ungroup()

# left vs right vs away
fit <- glmer(cbind(N.crr, N.frame-N.crr) ~ model + (1|filename), data=d.tmp.ind.sum %>% subset(variable=="crr3"),
             family=binomial, control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(fit)
Anova(fit)
emmeans(fit, "model", type="response") %>% pairs(adjust="bonferroni")
pred <- ggpredict(fit, terms=c("model"), type="fixed") %>% as.data.frame()
pred

# look vs away
fit <- glmer(cbind(N.crr, N.frame-N.crr) ~ model + (1|filename), data=d.tmp.ind.sum %>% subset(variable=="crr2"),
             family=binomial, control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(fit)
Anova(fit)
emmeans(fit, "model", type="response") %>% pairs(adjust="bonferroni")
pred <- ggpredict(fit, terms=c("model"), type="fixed") %>% as.data.frame()
pred
```


# Effects of noise factors on gaze classification prediction

```{r}
# left vs right vs away (absolute value)
d.tmp.ind <- d.tmp.ind %>% left_join(d.raw.noise.sum2, by=intersect(colnames(d.tmp.ind), colnames(d.raw.noise.sum2)))

fit <- glmer(cbind(N.crr, N.frame-N.crr) ~ model * (distance_z + offset_abs_z + angle_abs_z + lighting_abs_z + movement_z) + (1|filename), 
             data=d.tmp.ind %>% subset(variable=="crr3"), family=binomial,
             # control=glmerControl(optimizer="nlminbwrap", calc.derivs = FALSE, optCtrl = list(maxfun = 10000, maxiter=100000)))
             control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(fit)
Anova(fit)
emmeans(fit, ~ distance_z | model, type="response", at=list(distance_z = c(-1, 1))) %>% pairs(combine=TRUE, adjust="bonferroni")
emmeans(fit, ~ offset_abs_z | model, type="response", at=list(offset_abs_z = c(-1, 1))) %>% pairs(combine=TRUE, adjust="bonferroni")
emmeans(fit, ~ angle_abs_z | model, type="response", at=list(angle_abs_z = c(-1, 1))) %>% pairs(combine=TRUE, adjust="bonferroni")
emmeans(fit, ~ lighting_abs_z | model, type="response", at=list(lighting_abs_z = c(-1, 1))) %>% pairs(combine=TRUE, adjust="bonferroni")
emmeans(fit, ~ movement_z | model, type="response", at=list(movement_z = c(-1, 1))) %>% pairs(combine=TRUE, adjust="bonferroni")
# ggpredict(fit, terms=c("distance_z[-1,0,1]", "model"), type="fixed")
# ggpredict(fit, terms=c("offset_abs_z[-1,0,1]", "model"), type="fixed")
# ggpredict(fit, terms=c("angle_abs_z[-1,0,1]", "model"), type="fixed")
# ggpredict(fit, terms=c("lighting_abs_z[-1,0,1]", "model"), type="fixed")
# ggpredict(fit, terms=c("movement_z[-1,0,1]", "model"), type="fixed")

pred.cat3 <- ggpredict(fit, terms=c("distance_z[-1,1]", "model"), type="fixed") %>% as.data.frame() %>% rename(z_value=x, model=group) %>% 
  mutate(Term="distance_z") %>% 
  rbind(ggpredict(fit, terms=c("offset_abs_z[-1,1]", "model"), type="fixed") %>% as.data.frame() %>% rename(z_value=x, model=group) %>% 
  mutate(Term="offset_abs_z")) %>% 
  rbind(ggpredict(fit, terms=c("angle_abs_z[-1,1]", "model"), type="fixed") %>% as.data.frame() %>% rename(z_value=x, model=group) %>% 
  mutate(Term="angle_abs_z")) %>% 
  rbind(ggpredict(fit, terms=c("lighting_abs_z[-1,1]", "model"), type="fixed") %>% as.data.frame() %>% rename(z_value=x, model=group) %>% 
  mutate(Term="lighting_abs_z")) %>% 
  rbind(ggpredict(fit, terms=c("movement_z[-1,1]", "model"), type="fixed") %>% as.data.frame() %>% rename(z_value=x, model=group) %>% 
  mutate(Term="movement_z")) %>% 
  mutate(Term=factor(Term, levels=c("distance_z", "offset_abs_z", "angle_abs_z", "movement_z", "lighting_abs_z")))

pred.cat3$model <- c("icatcher"="iCatcher+", "owlet"="OWLET", "ar"="AR-based")[pred.cat3$model]
pred.cat3 <- pred.cat3 %>% mutate(model=factor(model, levels=c("iCatcher+", "OWLET", "AR-based")))

facet_labels <- c("distance_z"="Distance to \nthe camera",
                  "offset_abs_z"="Left-right \noffset",
                  "angle_abs_z"="Face \nrotation",
                  "movement_z"="Face \nmovement",
                  "lighting_abs_z"="Lighting \nsource")

pred.cat3 %>% 
  ggplot(aes(x=z_value, y=predicted, color=model, fill=model, shape=model))+
  geom_point(size=3)+
  geom_line(aes(group=model), linewidth=1)+
  geom_errorbar(aes(ymax=conf.high, ymin=conf.low), width=0.1)+
  theme_classic()+
  facet_grid(~Term, labeller=labeller(Term=facet_labels))+
  labs(y="Proportion of correct prediction", x="Z-value (-1SD: Ideal <-> +1SD: Noisy)", color="Model", shape="Model", fill="Model")+
  scale_x_continuous(limits=c(-1.3, 1.3), breaks=c(-1,1))+
  scale_y_continuous(limits=c(0.40, 0.92), breaks=seq(0.4, 1.0, 0.05))+
  theme(plot.title=element_text(size=16,face="bold", color="black"),
        axis.ticks=element_line(color = "black"),
        axis.text.x=element_text(size=14, color = "black"),
        axis.text=element_text(size=14, color = "black"),
        axis.title=element_text(size=14, color="black"),
        strip.text=element_text(size=12),
        legend.title=element_text(size=14, color="black", hjust=0.2),
        legend.text=element_text(size=13, color="black"))
ggsave(file=here("Figures", "Figure_2b.png"), dpi=350, width=7.5, height=6.5)
```


```{r}
# looking vs away (absolute value)
d.tmp.ind <- d.tmp.ind %>% left_join(d.raw.noise.sum2, by=intersect(colnames(d.tmp.ind), colnames(d.raw.noise.sum2)))

fit <- glmer(cbind(N.crr, N.frame-N.crr) ~ model * (distance_z + offset_abs_z + angle_abs_z + lighting_abs_z + movement_z) + (1|filename), 
             data=d.tmp.ind %>% subset(variable=="crr2"), family=binomial,
             # control=glmerControl(optimizer="nlminbwrap", calc.derivs = FALSE, optCtrl = list(maxfun = 10000, maxiter=100000)))
             control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(fit)
Anova(fit)
emmeans(fit, ~ distance_z | model, type="response", at=list(distance_z = c(-1, 1))) %>% pairs(combine=TRUE, adjust="bonferroni")
emmeans(fit, ~ offset_abs_z | model, type="response", at=list(offset_abs_z = c(-1, 1))) %>% pairs(combine=TRUE, adjust="bonferroni")
emmeans(fit, ~ angle_abs_z | model, type="response", at=list(angle_abs_z = c(-1, 1))) %>% pairs(combine=TRUE, adjust="bonferroni")
emmeans(fit, ~ lighting_abs_z | model, type="response", at=list(lighting_abs_z = c(-1, 1))) %>% pairs(combine=TRUE, adjust="bonferroni")
emmeans(fit, ~ movement_z | model, type="response", at=list(movement_z = c(-1, 1))) %>% pairs(combine=TRUE, adjust="bonferroni")
# ggpredict(fit, terms=c("distance_z[-1,0,1]", "model"), type="fixed")
# ggpredict(fit, terms=c("offset_abs_z[-1,0,1]", "model"), type="fixed")
# ggpredict(fit, terms=c("angle_abs_z[-1,0,1]", "model"), type="fixed")
# ggpredict(fit, terms=c("lighting_abs_z[-1,0,1]", "model"), type="fixed")
# ggpredict(fit, terms=c("movement_z[-1,0,1]", "model"), type="fixed")

pred.cat2 <- ggpredict(fit, terms=c("distance_z[-1,1]", "model"), type="fixed") %>% as.data.frame() %>% rename(z_value=x, model=group) %>% 
  mutate(Term="distance_z") %>% 
  rbind(ggpredict(fit, terms=c("offset_abs_z[-1,1]", "model"), type="fixed") %>% as.data.frame() %>% rename(z_value=x, model=group) %>% 
  mutate(Term="offset_abs_z")) %>% 
  rbind(ggpredict(fit, terms=c("angle_abs_z[-1,1]", "model"), type="fixed") %>% as.data.frame() %>% rename(z_value=x, model=group) %>% 
  mutate(Term="angle_abs_z")) %>% 
  rbind(ggpredict(fit, terms=c("lighting_abs_z[-1,1]", "model"), type="fixed") %>% as.data.frame() %>% rename(z_value=x, model=group) %>% 
  mutate(Term="lighting_abs_z")) %>% 
  rbind(ggpredict(fit, terms=c("movement_z[-1,1]", "model"), type="fixed") %>% as.data.frame() %>% rename(z_value=x, model=group) %>% 
  mutate(Term="movement_z")) %>% 
  mutate(Term=factor(Term, levels=c("distance_z", "offset_abs_z", "angle_abs_z", "movement_z", "lighting_abs_z")))

pred.cat2$model <- c("icatcher"="iCatcher+", "owlet"="OWLET", "ar"="AR-based")[pred.cat2$model]
pred.cat2 <- pred.cat2 %>% mutate(model=factor(model, levels=c("iCatcher+", "OWLET", "AR-based")))

facet_labels <- c("distance_z"="Distance to \nthe camera",
                  "offset_abs_z"="Left-right \noffset",
                  "angle_abs_z"="Face \nrotation",
                  "movement_z"="Face \nmovement",
                  "lighting_abs_z"="Lighting \nsource")

pred.cat2 %>% 
  ggplot(aes(x=z_value, y=predicted, color=model, fill=model, shape=model))+
  geom_point(size=3)+
  geom_line(aes(group=model), linewidth=1)+
  geom_errorbar(aes(ymax=conf.high, ymin=conf.low), width=0.1)+
  theme_classic()+
  facet_grid(~Term, labeller=labeller(Term=facet_labels))+
  labs(y="Proportion of correct prediction", x="Z-value (-1SD: Ideal <-> +1SD: Noisy)", color="Model", shape="Model", fill="Model")+
  scale_x_continuous(limits=c(-1.3, 1.3), breaks=c(-1,1))+
  scale_y_continuous(limits=c(0.40, 0.92), breaks=seq(0.4, 1.0, 0.05))+
  theme(plot.title=element_text(size=16,face="bold", color="black"),
        axis.ticks=element_line(color = "black"),
        axis.text.x=element_text(size=14, color = "black"),
        axis.text=element_text(size=14, color = "black"),
        axis.title=element_text(size=14, color="black"),
        strip.text=element_text(size=12),
        legend.title=element_text(size=14, color="black", hjust=0.2),
        legend.text=element_text(size=13, color="black"))
ggsave(file=here("Figures", "Figure_2a.png"), dpi=350, width=7.5, height=6.5)
```


```{r}
# left vs right vs away (leftward vs rightward)
d.tmp.ind <- d.tmp.ind %>% left_join(d.raw.noise.sum3, by=intersect(colnames(d.tmp.ind), colnames(d.raw.noise.sum3)))

fit <- glmer(cbind(N.crr, N.frame-N.crr) ~ model * (offset_bin + angle_bin + lighting_bin) + (1|filename), 
             data=d.tmp.ind %>% subset(variable=="crr3"), family=binomial,
             # control=glmerControl(optimizer="nlminbwrap", calc.derivs = FALSE, optCtrl = list(maxfun = 10000, maxiter=100000)))
             control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(fit)
Anova(fit)

emmeans(fit, ~ offset_bin | model, type="response") %>% pairs(combine=TRUE, adjust="bonferroni")
emmeans(fit, ~ angle_bin | model, type="response") %>% pairs(combine=TRUE, adjust="bonferroni")
emmeans(fit, ~ lighting_bin | model, type="response") %>% pairs(combine=TRUE, adjust="bonferroni")
# ggpredict(fit, terms=c("offset_bin", "model"), type="fixed")
# ggpredict(fit, terms=c("angle_bin", "model"), type="fixed")
# ggpredict(fit, terms=c("lighting_bin", "model"), type="fixed")

pred.cat3 <- ggpredict(fit, terms=c("offset_bin", "model"), type="fixed") %>% as.data.frame() %>% 
  rename(binNum=x, model=group) %>% mutate(Term="offset") %>% 
  rbind(ggpredict(fit, terms=c("angle_bin", "model"), type="fixed") %>% as.data.frame() %>% 
  rename(binNum=x, model=group) %>% mutate(Term="angle")) %>% 
  rbind(ggpredict(fit, terms=c("lighting_bin", "model"), type="fixed") %>% as.data.frame() %>% 
  rename(binNum=x, model=group) %>% mutate(Term="lighting")) %>%  
  mutate(Term=factor(Term, levels=c("offset", "angle", "lighting")))

pred.cat3$model <- c("icatcher"="iCatcher+", "owlet"="OWLET", "ar"="AR-based")[pred.cat3$model]
pred.cat3 <- pred.cat3 %>% mutate(model=factor(model, levels=c("iCatcher+", "OWLET", "AR-based")))

facet_labels <- c("offset"="Left-right \noffset",
                  "angle"="Face \nrotation",
                  "lighting"="Lighting \nsource")

pred.cat3 <- pred.cat3 %>% 
  mutate(binLabel = case_when(Term=="offset" & binNum==1 ~ "~-30",
                              Term=="offset" & binNum==2 ~ "-30~0",
                              Term=="offset" & binNum==3 ~ "0~+30",
                              Term=="offset" & binNum==4 ~ "+30~",
                              Term=="angle" & binNum==1 ~ "~-5",
                              Term=="angle" & binNum==2 ~ "-5~0",
                              Term=="angle" & binNum==3 ~ "0~+5",
                              Term=="angle" & binNum==4 ~ "+5~",
                              Term=="lighting" & binNum==1 ~ "~-25",
                              Term=="lighting" & binNum==2 ~ "-25~0",
                              Term=="lighting" & binNum==3 ~ "0~+25",
                              Term=="lighting" & binNum==4 ~ "+25~")) %>% 
  mutate(binLabel=factor(binLabel,
                         levels=c("~-30", "-30~0", "0~+30", "+30~",
                                  "~-5", "-5~0", "0~+5", "+5~",
                                  "~-25", "-25~0", "0~+25", "+25~"))) 

vline_df <- pred.cat3 %>% filter(binNum %in% c(2, 3)) %>%
  group_by(Term) %>%
  summarize(x1=binLabel[binNum==2][1], x2=binLabel[binNum==3][1], .groups="drop") %>%
  mutate(xintercept=2.5)

pred.cat3 %>% ggplot(aes(x=binLabel, y=predicted, color=model, fill=model, shape=model))+
  geom_point(size=3)+
  geom_line(aes(group=model), linewidth=1)+
  geom_errorbar(aes(ymax=conf.high, ymin=conf.low), width=0.1)+
  geom_vline(data=vline_df, aes(xintercept=xintercept), linetype="dashed") +
  theme_classic()+
  facet_grid(~Term, labeller=labeller(Term=facet_labels), scales="free_x")+
  labs(y="Proportion of correct prediction", 
       x="Left-right offset[mm], Face rotation[degree], Lighting source[L]", 
       color="Model", shape="Model", fill="Model")+
  scale_y_continuous(limits=c(0.40, 0.923), breaks=seq(0.4, 1.0, 0.05))+
  theme(plot.title=element_text(size=16,face="bold", color="black"),
        axis.ticks=element_line(color = "black"),
        axis.text.x=element_text(size=14, color = "black", angle=45, h=1),
        axis.text=element_text(size=14, color = "black"),
        axis.title=element_text(size=14, color="black"),
        strip.text=element_text(size=12),
        legend.title=element_text(size=14, color="black", hjust=0.2),
        legend.text=element_text(size=13, color="black"))
  ggsave(file=here("Figures", "Figure_3b.png"), dpi=350, width=7.5, height=6.5)
```



```{r}
# # looking vs away (leftward vs rightward)
d.tmp.ind <- d.tmp.ind %>% left_join(d.raw.noise.sum3, by=intersect(colnames(d.tmp.ind), colnames(d.raw.noise.sum3)))

fit <- glmer(cbind(N.crr, N.frame-N.crr) ~ model * (offset_bin + angle_bin + lighting_bin) + (1|filename), 
             data=d.tmp.ind %>% subset(variable=="crr2"), family=binomial,
             # control=glmerControl(optimizer="nlminbwrap", calc.derivs = FALSE, optCtrl = list(maxfun = 10000, maxiter=100000)))
             control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(fit)
Anova(fit)

emmeans(fit, ~ offset_bin | model, type="response") %>% pairs(combine=TRUE, adjust="bonferroni")
emmeans(fit, ~ angle_bin | model, type="response") %>% pairs(combine=TRUE, adjust="bonferroni")
emmeans(fit, ~ lighting_bin | model, type="response") %>% pairs(combine=TRUE, adjust="bonferroni")
# ggpredict(fit, terms=c("offset_bin", "model"), type="fixed")
# ggpredict(fit, terms=c("angle_bin", "model"), type="fixed")
# ggpredict(fit, terms=c("lighting_bin", "model"), type="fixed")

pred.cat2 <- ggpredict(fit, terms=c("offset_bin", "model"), type="fixed") %>% as.data.frame() %>% 
  rename(binNum=x, model=group) %>% mutate(Term="offset") %>% 
  rbind(ggpredict(fit, terms=c("angle_bin", "model"), type="fixed") %>% as.data.frame() %>% 
  rename(binNum=x, model=group) %>% mutate(Term="angle")) %>% 
  rbind(ggpredict(fit, terms=c("lighting_bin", "model"), type="fixed") %>% as.data.frame() %>% 
  rename(binNum=x, model=group) %>% mutate(Term="lighting")) %>%  
  mutate(Term=factor(Term, levels=c("offset", "angle", "lighting")))

pred.cat2$model <- c("icatcher"="iCatcher+", "owlet"="OWLET", "ar"="AR-based")[pred.cat2$model]
pred.cat2 <- pred.cat2 %>% mutate(model=factor(model, levels=c("iCatcher+", "OWLET", "AR-based")))

facet_labels <- c("offset"="Left-right \noffset",
                  "angle"="Face \nrotation",
                  "lighting"="Lighting \nsource")

pred.cat2 <- pred.cat2 %>% 
  mutate(binLabel = case_when(Term=="offset" & binNum==1 ~ "~-30",
                              Term=="offset" & binNum==2 ~ "-30~0",
                              Term=="offset" & binNum==3 ~ "0~+30",
                              Term=="offset" & binNum==4 ~ "+30~",
                              Term=="angle" & binNum==1 ~ "~-5",
                              Term=="angle" & binNum==2 ~ "-5~0",
                              Term=="angle" & binNum==3 ~ "0~+5",
                              Term=="angle" & binNum==4 ~ "+5~",
                              Term=="lighting" & binNum==1 ~ "~-25",
                              Term=="lighting" & binNum==2 ~ "-25~0",
                              Term=="lighting" & binNum==3 ~ "0~+25",
                              Term=="lighting" & binNum==4 ~ "+25~")) %>% 
  mutate(binLabel=factor(binLabel,
                         levels=c("~-30", "-30~0", "0~+30", "+30~",
                                  "~-5", "-5~0", "0~+5", "+5~",
                                  "~-25", "-25~0", "0~+25", "+25~"))) 

vline_df <- pred.cat2 %>% filter(binNum %in% c(2, 3)) %>%
  group_by(Term) %>%
  summarize(x1=binLabel[binNum==2][1], x2=binLabel[binNum==3][1], .groups="drop") %>%
  mutate(xintercept=2.5)

pred.cat2 %>% ggplot(aes(x=binLabel, y=predicted, color=model, fill=model, shape=model))+
  geom_point(size=3)+
  geom_line(aes(group=model), linewidth=1)+
  geom_errorbar(aes(ymax=conf.high, ymin=conf.low), width=0.1)+
  geom_vline(data=vline_df, aes(xintercept=xintercept), linetype="dashed") +
  theme_classic()+
  facet_grid(~Term, labeller=labeller(Term=facet_labels), scales="free_x")+
  labs(y="Proportion of correct prediction", 
       x="Left-right offset[mm], Face rotation[degree], Lighting source[L]", 
       color="Model", shape="Model", fill="Model")+
  scale_y_continuous(limits=c(0.40, 0.923), breaks=seq(0.4, 1.0, 0.05))+
  theme(plot.title=element_text(size=16,face="bold", color="black"),
        axis.ticks=element_line(color = "black"),
        axis.text.x=element_text(size=14, color = "black", angle=45, h=1),
        axis.text=element_text(size=14, color = "black"),
        axis.title=element_text(size=14, color="black"),
        strip.text=element_text(size=12),
        legend.title=element_text(size=14, color="black", hjust=0.2),
        legend.text=element_text(size=13, color="black"))
ggsave(file=here("Figures", "Figure_3a.png"), dpi=350, width=7.5, height=6.5)
```



```{r}
# Effects of experimental stimuli on gaze classification prediction (if interested)

# left vs right vs away
fit <- glmer(cbind(N.crr, N.frame-N.crr) ~ model * (objectMovement + complexity + shape + sound + trial) + (1|filename), 
             data=d.tmp.ind %>% subset(variable=="crr3"), family=binomial,
             # control=glmerControl(optimizer="nlminbwrap", calc.derivs = FALSE, optCtrl = list(maxfun = 10000, maxiter=100000)))
             control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

fit <- glm(cbind(N.crr, N.frame-N.crr) ~ model * (objectMovement + complexity + shape + sound + trial), 
             data=d.tmp.ind %>% subset(variable=="crr3"), family=binomial)
summary(fit)
Anova(fit)
emmeans(fit, ~ objectMovement | model) %>% pairs(combine=TRUE, adjust="bonferroni") 
emmeans(fit, ~ complexity | model) %>% pairs(combine=TRUE, adjust="bonferroni") 
emmeans(fit, ~ shape | model) %>% pairs(combine=TRUE, adjust="bonferroni") 
emmeans(fit, ~ sound | model) %>% pairs(combine=TRUE, adjust="bonferroni") 
emmeans(fit, ~ trial | model, at=list(trial = c(1, 6, 12))) %>% pairs(combine=TRUE, adjust="bonferroni") 
ggpredict(fit, terms=c("objectMovement", "complexity", "shape", "sound", "trial[All]"), condition=c(model="icatcher"), type="fixed")
ggpredict(fit, terms=c("objectMovement", "complexity", "shape", "sound", "trial[All]"), condition=c(model="owlet"), type="fixed")
ggpredict(fit, terms=c("objectMovement", "complexity", "shape", "sound", "trial[All]"), condition=c(model="ar"), type="fixed")

# look vs away
fit <- glmer(cbind(N.crr, N.frame-N.crr) ~ model * (objectMovement + complexity + shape + sound + trial) + (1|filename), 
             data=d.tmp.ind %>% subset(variable=="crr2"), family=binomial,
             # control=glmerControl(optimizer="nlminbwrap", calc.derivs = FALSE, optCtrl = list(maxfun = 10000, maxiter=100000)))
             control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

fit <- glm(cbind(N.crr, N.frame-N.crr) ~ model * (objectMovement + complexity + shape + sound + trial), 
             data=d.tmp.ind %>% subset(variable=="crr2"), family=binomial)

summary(fit)
Anova(fit)
emmeans(fit, ~ objectMovement | model) %>% pairs(combine=TRUE, adjust="bonferroni") 
emmeans(fit, ~ complexity | model) %>% pairs(combine=TRUE, adjust="bonferroni") 
emmeans(fit, ~ shape | model) %>% pairs(combine=TRUE, adjust="bonferroni") 
emmeans(fit, ~ sound | model) %>% pairs(combine=TRUE, adjust="bonferroni") 
emmeans(fit, ~ trial | model, at=list(trial = c(1, 6, 12))) %>% pairs(combine=TRUE, adjust="bonferroni") 
ggpredict(fit, terms=c("objectMovement", "complexity", "shape", "sound", "trial[All]"), condition=c(model="icatcher"), type="fixed")
ggpredict(fit, terms=c("objectMovement", "complexity", "shape", "sound", "trial[All]"), condition=c(model="owlet"), type="fixed")
ggpredict(fit, terms=c("objectMovement", "complexity", "shape", "sound", "trial[All]"), condition=c(model="ar"), type="fixed")
```

